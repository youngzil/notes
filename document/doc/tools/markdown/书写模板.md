# pagefame升级相关操作

## 一、pageCode和srvCode的关系存储

#### 1、需要修改引用pageframe的web3.0的配置文件AIConfig.xml

1. 修改IS_SRV_CHECK_FLAG的值为Y，用于开启pageCode和srvCode的关系存储逻辑

2. 新增

   ```
   <ConfigItem name="SRV_KAFKA_SERVERS" remarks="pageCode与srvCode关联数据存入的kafka节点地址">20.26.38.116:9292</ConfigItem>
   ```

	内容为kafka部署地址

   

#### 2、根据需要调整request.xml

```
<!-- pageCode和srvCode关系存储集合的最大限制容量，超过部分不记录-->
<pageCodeSrvMapMaxSize>1000</pageCodeSrvMapMaxSize>
<!-- pageCode和srvCode关系存入kafka的线程睡眠间隔-->
<pageCodeSrvThreadSleep>5000</pageCodeSrvThreadSleep>
<!-- 读取pageCode和srvCode关系是否开启记录逻辑状态的线程睡眠间隔-->
<pageCodeSrvOpenStateThreadSleep>120000</pageCodeSrvOpenStateThreadSleep>
<!-- pageCode和srvCode写入kafka的主题名，需要与jstorm任务中的主题名相同-->
<kafkaTopicName>PAGE_CODE_SRV</kafkaTopicName>
```

可根据环境使用情况来设置最适合的大小



#### 3、配置静态缓存数据

测试环境对应的是`jdbc:oracle:thin:@//csdba1.yw.zj.chinamobile.com:1523/csdba2`这个数据库中的BS_STATIC_DATA表。向表中新增一条数据

```sql
insert into BS_STATIC_DATA(code_type, code_value, code_name, code_desc, code_type_alias, sort_id, state, extern_code_type) VALUES('PAGE_CODE_SRV_STATE','Y','page和service记录开关','是否记录pageCode和srvCode的关系数据开关','PAGE_CODE_SRV_STATE',null,'U',null);
```

新增完数据之后，**开关pageCode和srvCode的关系数据记录就只需要修改表中的这条数据的code_value（Y/N）的值即可**。



#### 4、添加kafka相关jar包

gradle依赖获取源配置`maven { url "http://nexus.zj.chinamobile.com:8081/nexus/content/groups/public/" }`

gradle依赖配置`compile group: 'org.apache.kafka', name: 'kafka_2.11', version:'0.8.2.2'`



#### 5、jstorm任务jar包配置文件

在jar包中有一个配置文件application.properties，内容如下：

```
# kafka的topic主题名
kafka.topicName = PAGE_CODE_SRV
# kafka在zk上存储数据的地址
kafka.broker.zk.path = /kafka/brokers
# zk地址
kafka.zookeeper.connect = 20.26.38.112:2181
# kafka读取的id（可随便取）
kafka.id = group-1
# es批量写入的单批次数量
es.batch.size = 40
# elasticsearch的http访问地址
es.server.address = http://20.26.38.117:9200,http://20.26.38.118:9200,http://20.26.38.120:9200
# elasticsearch插入数据的index
es.index = page_code_srv
# elasticsearch插入数据的type
es.type = page_srv_relate
```

根据具体情况手动修改配置文件中的内容



#### 4、jstorm任务jar包的启动

```shell
jstorm jar 要运行的jar包名称 com.asiainfo.Topology Page_Srv_Topology 1 3 1000
```

**注：**

1. `com.asiainfo.Topology`：要运行的main方法路径
2. `Page_Srv_Topology`：第一个参数（必填），表示topology任务的名称
3. `1`：第二个参数（选填），表示spout的并行数，默认为1
4. `3`：第三个参数（选填），表示bolt的并行数，默认为3
5. `1000`：第四个参数（选填），表示一个spout task已经emit等待ack的tuple的最大数量，默认为1000



**备注**：

- pageCode和srvCode的关系数据每隔5秒会往kafka中写入一次（可设置）
- 当维护在pageframe中的集合容量达到1000则不再记录关系数据（可设置）
- jstorm任务es-bolt当spout的数据发送来达到40则会写入elasticsearch中（可设置）
- pageCode和srvCode的关系记录开关状态默认为每2分钟从数据库中获取一次（可配置）



## 二、pageframe关于网关有效性检验修改的相关操作

#### 1、修改AIConfig.xml配置文件

在configkind的名称为PRIVILEGE_PERMISSION的子项中新增一句：

```xml
<ConfigItem name="IS_VERIFY_CHECK_FLAG" remarks="是否做网关ticket和请求有效性校验">Y</ConfigItem>
```



#### 2、修改request.xml配置文件

在`<page>`中新增如下内容：

```xml
<!-- 网关请求有效性验证页面（此处填些所有的涉及网关的pageCode，中间用';'分隔）-->
<getwayPagepath></getwayPagepath>
<!-- 网关ticket有效性校验接口地址（根据不同环境来填写对应的）-->
<ticketCheckAddress>http://aifgatewaytest.zj.chinamobile.com:20150/oauth2/authorization/checkTicketPageCode</ticketCheckAddress>
<!-- 网关请求有效性校验接口地址（根据不同环境来填写对应的）-->
<tokenCheckAddress>http://aifgatewaytest.zj.chinamobile.com:20150/oauth2/authorization/token</tokenCheckAddress>
```

> 